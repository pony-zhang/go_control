# 运动控制核心系统设计文档

## 1. 架构总览

系统采用分层、模块化、面向接口的设计，自上而下形成清晰的数据流与控制流，各层职责单一、松耦合，支持热插拔与协议无关性。整体架构如下：

```
┌──────────────────────┐
│      GUI Client      │ ←→ IPC ↔
├──────────────────────┤
│      Event Loop      │
├──────────────────────┤
│     Task Trigger     │
├──────────────────────┤
│ Task Dispatch & Scheduler │
├──────────────────────┤
│    Task Decomposer   │
├──────────────────────┤
│    Execution Queue   │
├──────────────────────┤
│   Command Executor   │
├──────────────────────┤
│   Device Interface   │  ← 硬件抽象层（内嵌）
└──────────────────────┘
```

> **说明**：硬件抽象能力以内嵌方式集成于底层，不作为独立层级暴露，而是通过统一设备接口为上层提供协议无关的访问能力。

---

## 2. 模块职责与交互

### 2.1 IPC 通信层
- 提供双向、异步、带优先级的消息通道（基于 Unix Socket 或 TCP）
- 支持多客户端（GUI、调试器、上位系统）
- 消息类型包括：控制命令、状态订阅、配置同步、事件通知
- 内置消息序列化（JSON/Protobuf）、连接保活与断线恢复

### 2.2 Event Loop（事件主循环）
- 系统调度中枢，驱动各模块按节奏运行
- 可配置循环周期（默认 1–10ms），保障实时性
- 管理模块生命周期，协调启动/停止/重载流程
- 集成看门狗与异常熔断机制

### 2.3 Task Trigger（任务触发器）
- 聚合多源触发信号：IPC 指令、定时器、外部 IO、传感器事件
- 对任务进行前置校验：运动范围、速度/加速度限制、系统状态兼容性
- 初步标记任务类型与优先级（如：急停 > 安全回零 > 自动流程 > 手动点动）

### 2.4 Task Dispatch & Scheduler（任务调度器）
- 维护多优先级任务队列（高/中/低 + 紧急通道）
- 实施抢占式调度：高优任务可中断低优任务（如急停中断运动）
- 进行资源冲突检测（如同一轴不可同时执行两个移动指令）
- 支持任务暂停、恢复、取消与依赖编排

### 2.5 Task Decomposer（任务拆解器）
- 将语义化任务（如 “MoveTo(X=100, Y=200)”）转换为底层可执行指令流
- 内置轨迹规划器：支持点到点、直线插补、圆弧插补等
- 从配置文件（YAML/JSON）加载轴参数、运动学模型、安全边界
- 输出标准化的 `MotionCommand` 序列，与具体硬件解耦

### 2.6 Execution Queue（执行队列）
- 采用环形缓冲区存储待执行指令，支持高效并发读写
- 指令状态全生命周期追踪：Pending → Sent → Executing → Done/Failed
- 支持指令批处理、动态插入（如在线插入暂停点）与延迟补偿
- 与 Command Executor 通过 channel 解耦，实现背压控制

### 2.7 Command Executor（指令执行器）
- 从执行队列消费指令，调用统一设备接口下发
- 监控执行结果：超时检测、位置反馈比对、错误码解析
- 支持模拟模式（Mock Device）用于无硬件开发与测试
- 实时上报执行状态至上层，驱动状态机更新

### 2.8 Device Interface（设备接口层 — 硬件抽象内核）
- **定位**：作为 Command Executor 的依赖，提供协议无关的设备操作接口
- **核心接口**：
  ```go
  type Device interface {
      Write(cmd Command) error
      Read(reg string) (Value, error)
      Connect() error
      Disconnect()
      Status() DeviceStatus
  }
  ```
- **协议适配器**（插件式实现）：
  - `ModbusDriver`：支持 RTU/TCP，自动处理寄存器映射
  - `CANopenDriver`：支持 SDO/PDO，集成对象字典解析
  - `SerialDriver`：适配自定义串口协议（帧结构可配置）
  - 可通过注册机制扩展新驱动（如 EtherCAT、Ethernet/IP）
- **设备管理**：
  - 启动时根据配置文件实例化对应驱动
  - 按轴 ID 或设备 ID 路由指令到具体设备
  - 自动重连、故障隔离、连接状态广播

---

## 3. 配置与扩展机制

- **统一配置体系**：四级配置（系统/设备/任务/用户），支持热重载
- **插件架构**：
  - 驱动插件：新增通信协议无需修改核心逻辑
  - 任务插件：扩展自定义任务类型（如视觉引导定位）
  - 调度策略插件：替换调度算法（如 EDF、Rate-Monotonic）
- **日志与可观测性**：
  - 结构化日志（Zap/Slog），按模块/级别过滤
  - 关键指标暴露（Prometheus）：队列长度、指令延迟、设备在线率

---

## 4. Go 语言实现原则

- **并发安全**：模块间通过 channel 通信，避免共享内存
- **接口抽象**：核心依赖基于接口（如 `Device`、`Scheduler`），便于测试与替换
- **资源控制**：使用 `context.Context` 管理生命周期，`sync.Pool` 优化高频对象
- **错误处理**：错误携带上下文信息，区分临时性与永久性故障
- **测试覆盖**：单元测试（接口 mock）+ 集成测试（真实/模拟设备）

---

该设计将硬件抽象能力无缝融入底层执行路径，上层模块完全无需感知通信协议细节，既满足对标准工业协议（Modbus、CANopen）的支持，也兼容私有串口协议，并通过插件机制保障长期可维护性与技术演进能力。整体架构符合工业控制系统的实时性、可靠性与可扩展性要求。
